(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.GuppyDoc = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var GuppyDoc = function(doc){
    doc = doc || "<m><e></e></m>";
    this.set_content(doc);
}

GuppyDoc.prototype.is_small = function(nn){
    var n = nn.parentNode;
    while(n != null && n.nodeName != 'm'){
	if(n.getAttribute("small") == "yes") return true;
	n = n.parentNode
	while(n != null && n.nodeName != 'c') n = n.parentNode;
    }
    return false;
}

GuppyDoc.prototype.ensure_text_nodes = function(){
    var l = this.base.getElementsByTagName("e");
    for (var i = 0; i < l.length; i++){
        if (!(l[i].firstChild))
            l[i].appendChild(this.base.createTextNode(""));
    }
}

GuppyDoc.prototype.is_blank = function(){
    if (this.base.getElementsByTagName("f").length > 0)
        return false;
    var l = this.base.getElementsByTagName("e");
    if (l.length == 1 && (!(l[0].firstChild) || l[0].firstChild.textContent == ""))
        return true;
    return false;
}

GuppyDoc.prototype.root = function(){
    return this.base.documentElement;
}

GuppyDoc.prototype.get_content = function(t,r) {
    //@ preprocess
    if (t != "xml")
        return this.manual_render(t, this.root(), r);
    else
        return (new XMLSerializer()).serializeToString(this.base);
}

GuppyDoc.prototype.xpath_node = function(xpath, node){
    node = node || this.root()
    return this.base.evaluate(xpath, node, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
}

GuppyDoc.prototype.xpath_list = function(xpath, node){
    node = node || this.root()
    return this.base.evaluate(xpath, node, null, XPathResult.ORDERED_NODE_ITERATOR_TYPE, null);
}

GuppyDoc.prototype.get_symbols = function(groups){
    var types = {};
    var ans = [];
    var iterator = groups ? this.xpath_list("//f") : this.xpath_list("//f[@group='"+groups[i]+"']");
    for(var nn = iterator.iterateNext(); nn != null; nn = iterator.iterateNext())
	types[nn.getAttribute("type")] = true;
    for(var t in types)
	ans.push(t);
    return ans;
}

GuppyDoc.prototype.set_content = function(xml_data) {
    this.base = (new window.DOMParser()).parseFromString(xml_data, "text/xml");
    this.ensure_text_nodes();
}

GuppyDoc.bracket_xpath = "(count(./*) != 1 and not \
		          ( \
                            count(./e)=2 and \
			    count(./f)=1 and \
			    count(./e[string-length(text())=0])=2 and \
			    ( \
			      (\
                                count(./f/c)=1 and\
			        count(./f/c[@is_bracket='yes'])=1\
			      )\
			      or\
			      (\
			        f/@c='yes' and \
				count(./e[@current='yes'])=0 and \
				count(./e[@temp='yes'])=0 \
			      )\
			    )\
			  )\
			)  \
			or\
		        (\
			  count(./*) = 1 and \
			  string-length(./e/text()) != 1 and \
			  number(./e/text()) != ./e/text() \
			) \
			or \
		        ( \
			  count(./*) = 1 and \
			  ./e/@current = 'yes' \
			) \
			or \
		        ( \
			  count(./*) = 1 and \
			  ./e/@temp = 'yes' \
			)"

GuppyDoc.prototype.manual_render = function(t, n, r) {
    var ans = "";
    if (n.nodeName == "e") {
        if (t == "latex" && r) {
            ans = n.getAttribute("render");
        } else if(t == "text"){
            ans = GuppyUtils.get_value(n);
            if (n.previousSibling && n.nextSibling && ans == "")
                ans = " * ";
            else {
                ans = ans.replace(/(.)([^a-zA-Z0-9.])(.)/g, "$1 $2 $3");
                ans = ans.replace(/([a-zA-Z])(?=\.)/g, "$1 * ");
                ans = ans.replace(/(\.)(?=[a-zA-Z])/g, "$1 * ");
                ans = ans.replace(/([a-zA-Z])(?=[a-zA-Z0-9])/g, "$1 * ");
                ans = ans.replace(/([a-zA-Z0-9])(?=[a-zA-Z])/g, "$1 * ");
                if (n.previousSibling && n.previousSibling.getAttribute("group") != "operations")
                    ans = ans.replace(/^([a-zA-Z0-9])/g, " * $1");
                if (n.nextSibling && n.nextSibling.getAttribute("group") != "operations")
                    ans = ans.replace(/([a-zA-Z0-9])$/g, "$1 * ");
                ans = " " + ans + " ";
            }
        } else {
            ans = GuppyUtils.get_value(n);
        }
    } else if(n.nodeName == "f") {
        var real_type = (t == "latex" && this.is_small(n)) ? "small_latex" : t;
        var nn = this.xpath_node("./b[@p='" + real_type + "']", n) || this.xpath_node("./b[@p='" + t + "']", n);
        if (nn)
            ans = this.manual_render(t, nn, r);
    } else if(n.nodeName == "b") {
        var cs = [];
        var i = 1;
        var par = n.parentNode;
        for (var nn = par.firstChild; nn != null; nn = nn.nextSibling)
            if (nn.nodeName == "c" || nn.nodeName == "l")
                cs[i++] = this.manual_render(t, nn, r);
        for (var nn = n.firstChild; nn != null; nn = nn.nextSibling) {
            if (nn.nodeType == 3)
                ans += nn.textContent;
            else if (nn.nodeType == 1) {
                if(nn.hasAttribute("d")){
                    var dim = parseInt(nn.getAttribute("d"));
                    var joiner = function(d, l) {
                        if (d > 1)
                            for (var k = 0; k < l.length; k++)
                                l[k] = joiner(d-1, l[k]);
                        return l.join(nn.getAttribute('sep' + (d - 1)));
                    };
                    ans += joiner(dim,cs[parseInt(nn.getAttribute("ref"))]);
                } else
                    ans += cs[parseInt(nn.getAttribute("ref"))];
            }
        }
    } else if(n.nodeName == "l") {
        ans = [];
        var i = 0;
        for (var nn = n.firstChild; nn != null; nn = nn.nextSibling){
            ans[i++] = this.manual_render(t, nn, r);
        }
    } else if(n.nodeName == "c" || n.nodeName == "m") {
        for (var nn = n.firstChild; nn != null; nn = nn.nextSibling)
            ans += this.manual_render(t, nn, r);
        if (t == "latex" &&
                n.getAttribute("bracket") == "yes" &&
                this.base.evaluate(GuppyDoc.bracket_xpath, n, null,
                XPathResult.BOOLEAN_TYPE, null).booleanValue) { 
            ans = "\\left(" + ans + "\\right)";
        }
    }
    return ans;
}

GuppyDoc.prototype.path_to = function(n){
    var name = n.nodeName;
    if(name == "m") return "guppy_loc_m";
    var ns = 0;
    for(var nn = n; nn != null; nn = nn.previousSibling) if(nn.nodeType == 1 && nn.nodeName == name) ns++;
    return this.path_to(n.parentNode)+"_"+name+""+ns;
}

module.exports = GuppyDoc;

},{}]},{},[1])(1)
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL25vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJzcmMvZ3VwcHlfZG9jLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCJ2YXIgR3VwcHlEb2MgPSBmdW5jdGlvbihkb2Mpe1xuICAgIGRvYyA9IGRvYyB8fCBcIjxtPjxlPjwvZT48L20+XCI7XG4gICAgdGhpcy5zZXRfY29udGVudChkb2MpO1xufVxuXG5HdXBweURvYy5wcm90b3R5cGUuaXNfc21hbGwgPSBmdW5jdGlvbihubil7XG4gICAgdmFyIG4gPSBubi5wYXJlbnROb2RlO1xuICAgIHdoaWxlKG4gIT0gbnVsbCAmJiBuLm5vZGVOYW1lICE9ICdtJyl7XG5cdGlmKG4uZ2V0QXR0cmlidXRlKFwic21hbGxcIikgPT0gXCJ5ZXNcIikgcmV0dXJuIHRydWU7XG5cdG4gPSBuLnBhcmVudE5vZGVcblx0d2hpbGUobiAhPSBudWxsICYmIG4ubm9kZU5hbWUgIT0gJ2MnKSBuID0gbi5wYXJlbnROb2RlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5cbkd1cHB5RG9jLnByb3RvdHlwZS5lbnN1cmVfdGV4dF9ub2RlcyA9IGZ1bmN0aW9uKCl7XG4gICAgdmFyIGwgPSB0aGlzLmJhc2UuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJlXCIpO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbC5sZW5ndGg7IGkrKyl7XG4gICAgICAgIGlmICghKGxbaV0uZmlyc3RDaGlsZCkpXG4gICAgICAgICAgICBsW2ldLmFwcGVuZENoaWxkKHRoaXMuYmFzZS5jcmVhdGVUZXh0Tm9kZShcIlwiKSk7XG4gICAgfVxufVxuXG5HdXBweURvYy5wcm90b3R5cGUuaXNfYmxhbmsgPSBmdW5jdGlvbigpe1xuICAgIGlmICh0aGlzLmJhc2UuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJmXCIpLmxlbmd0aCA+IDApXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB2YXIgbCA9IHRoaXMuYmFzZS5nZXRFbGVtZW50c0J5VGFnTmFtZShcImVcIik7XG4gICAgaWYgKGwubGVuZ3RoID09IDEgJiYgKCEobFswXS5maXJzdENoaWxkKSB8fCBsWzBdLmZpcnN0Q2hpbGQudGV4dENvbnRlbnQgPT0gXCJcIikpXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIHJldHVybiBmYWxzZTtcbn1cblxuR3VwcHlEb2MucHJvdG90eXBlLnJvb3QgPSBmdW5jdGlvbigpe1xuICAgIHJldHVybiB0aGlzLmJhc2UuZG9jdW1lbnRFbGVtZW50O1xufVxuXG5HdXBweURvYy5wcm90b3R5cGUuZ2V0X2NvbnRlbnQgPSBmdW5jdGlvbih0LHIpIHtcbiAgICAvL0AgcHJlcHJvY2Vzc1xuICAgIGlmICh0ICE9IFwieG1sXCIpXG4gICAgICAgIHJldHVybiB0aGlzLm1hbnVhbF9yZW5kZXIodCwgdGhpcy5yb290KCksIHIpO1xuICAgIGVsc2VcbiAgICAgICAgcmV0dXJuIChuZXcgWE1MU2VyaWFsaXplcigpKS5zZXJpYWxpemVUb1N0cmluZyh0aGlzLmJhc2UpO1xufVxuXG5HdXBweURvYy5wcm90b3R5cGUueHBhdGhfbm9kZSA9IGZ1bmN0aW9uKHhwYXRoLCBub2RlKXtcbiAgICBub2RlID0gbm9kZSB8fCB0aGlzLnJvb3QoKVxuICAgIHJldHVybiB0aGlzLmJhc2UuZXZhbHVhdGUoeHBhdGgsIG5vZGUsIG51bGwsIFhQYXRoUmVzdWx0LkZJUlNUX09SREVSRURfTk9ERV9UWVBFLCBudWxsKS5zaW5nbGVOb2RlVmFsdWU7XG59XG5cbkd1cHB5RG9jLnByb3RvdHlwZS54cGF0aF9saXN0ID0gZnVuY3Rpb24oeHBhdGgsIG5vZGUpe1xuICAgIG5vZGUgPSBub2RlIHx8IHRoaXMucm9vdCgpXG4gICAgcmV0dXJuIHRoaXMuYmFzZS5ldmFsdWF0ZSh4cGF0aCwgbm9kZSwgbnVsbCwgWFBhdGhSZXN1bHQuT1JERVJFRF9OT0RFX0lURVJBVE9SX1RZUEUsIG51bGwpO1xufVxuXG5HdXBweURvYy5wcm90b3R5cGUuZ2V0X3N5bWJvbHMgPSBmdW5jdGlvbihncm91cHMpe1xuICAgIHZhciB0eXBlcyA9IHt9O1xuICAgIHZhciBhbnMgPSBbXTtcbiAgICB2YXIgaXRlcmF0b3IgPSBncm91cHMgPyB0aGlzLnhwYXRoX2xpc3QoXCIvL2ZcIikgOiB0aGlzLnhwYXRoX2xpc3QoXCIvL2ZbQGdyb3VwPSdcIitncm91cHNbaV0rXCInXVwiKTtcbiAgICBmb3IodmFyIG5uID0gaXRlcmF0b3IuaXRlcmF0ZU5leHQoKTsgbm4gIT0gbnVsbDsgbm4gPSBpdGVyYXRvci5pdGVyYXRlTmV4dCgpKVxuXHR0eXBlc1tubi5nZXRBdHRyaWJ1dGUoXCJ0eXBlXCIpXSA9IHRydWU7XG4gICAgZm9yKHZhciB0IGluIHR5cGVzKVxuXHRhbnMucHVzaCh0KTtcbiAgICByZXR1cm4gYW5zO1xufVxuXG5HdXBweURvYy5wcm90b3R5cGUuc2V0X2NvbnRlbnQgPSBmdW5jdGlvbih4bWxfZGF0YSkge1xuICAgIHRoaXMuYmFzZSA9IChuZXcgd2luZG93LkRPTVBhcnNlcigpKS5wYXJzZUZyb21TdHJpbmcoeG1sX2RhdGEsIFwidGV4dC94bWxcIik7XG4gICAgdGhpcy5lbnN1cmVfdGV4dF9ub2RlcygpO1xufVxuXG5HdXBweURvYy5icmFja2V0X3hwYXRoID0gXCIoY291bnQoLi8qKSAhPSAxIGFuZCBub3QgXFxcblx0XHQgICAgICAgICAgKCBcXFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50KC4vZSk9MiBhbmQgXFxcblx0XHRcdCAgICBjb3VudCguL2YpPTEgYW5kIFxcXG5cdFx0XHQgICAgY291bnQoLi9lW3N0cmluZy1sZW5ndGgodGV4dCgpKT0wXSk9MiBhbmQgXFxcblx0XHRcdCAgICAoIFxcXG5cdFx0XHQgICAgICAoXFxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQoLi9mL2MpPTEgYW5kXFxcblx0XHRcdCAgICAgICAgY291bnQoLi9mL2NbQGlzX2JyYWNrZXQ9J3llcyddKT0xXFxcblx0XHRcdCAgICAgIClcXFxuXHRcdFx0ICAgICAgb3JcXFxuXHRcdFx0ICAgICAgKFxcXG5cdFx0XHQgICAgICAgIGYvQGM9J3llcycgYW5kIFxcXG5cdFx0XHRcdGNvdW50KC4vZVtAY3VycmVudD0neWVzJ10pPTAgYW5kIFxcXG5cdFx0XHRcdGNvdW50KC4vZVtAdGVtcD0neWVzJ10pPTAgXFxcblx0XHRcdCAgICAgIClcXFxuXHRcdFx0ICAgIClcXFxuXHRcdFx0ICApXFxcblx0XHRcdCkgIFxcXG5cdFx0XHRvclxcXG5cdFx0ICAgICAgICAoXFxcblx0XHRcdCAgY291bnQoLi8qKSA9IDEgYW5kIFxcXG5cdFx0XHQgIHN0cmluZy1sZW5ndGgoLi9lL3RleHQoKSkgIT0gMSBhbmQgXFxcblx0XHRcdCAgbnVtYmVyKC4vZS90ZXh0KCkpICE9IC4vZS90ZXh0KCkgXFxcblx0XHRcdCkgXFxcblx0XHRcdG9yIFxcXG5cdFx0ICAgICAgICAoIFxcXG5cdFx0XHQgIGNvdW50KC4vKikgPSAxIGFuZCBcXFxuXHRcdFx0ICAuL2UvQGN1cnJlbnQgPSAneWVzJyBcXFxuXHRcdFx0KSBcXFxuXHRcdFx0b3IgXFxcblx0XHQgICAgICAgICggXFxcblx0XHRcdCAgY291bnQoLi8qKSA9IDEgYW5kIFxcXG5cdFx0XHQgIC4vZS9AdGVtcCA9ICd5ZXMnIFxcXG5cdFx0XHQpXCJcblxuR3VwcHlEb2MucHJvdG90eXBlLm1hbnVhbF9yZW5kZXIgPSBmdW5jdGlvbih0LCBuLCByKSB7XG4gICAgdmFyIGFucyA9IFwiXCI7XG4gICAgaWYgKG4ubm9kZU5hbWUgPT0gXCJlXCIpIHtcbiAgICAgICAgaWYgKHQgPT0gXCJsYXRleFwiICYmIHIpIHtcbiAgICAgICAgICAgIGFucyA9IG4uZ2V0QXR0cmlidXRlKFwicmVuZGVyXCIpO1xuICAgICAgICB9IGVsc2UgaWYodCA9PSBcInRleHRcIil7XG4gICAgICAgICAgICBhbnMgPSBHdXBweVV0aWxzLmdldF92YWx1ZShuKTtcbiAgICAgICAgICAgIGlmIChuLnByZXZpb3VzU2libGluZyAmJiBuLm5leHRTaWJsaW5nICYmIGFucyA9PSBcIlwiKVxuICAgICAgICAgICAgICAgIGFucyA9IFwiICogXCI7XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBhbnMgPSBhbnMucmVwbGFjZSgvKC4pKFteYS16QS1aMC05Ll0pKC4pL2csIFwiJDEgJDIgJDNcIik7XG4gICAgICAgICAgICAgICAgYW5zID0gYW5zLnJlcGxhY2UoLyhbYS16QS1aXSkoPz1cXC4pL2csIFwiJDEgKiBcIik7XG4gICAgICAgICAgICAgICAgYW5zID0gYW5zLnJlcGxhY2UoLyhcXC4pKD89W2EtekEtWl0pL2csIFwiJDEgKiBcIik7XG4gICAgICAgICAgICAgICAgYW5zID0gYW5zLnJlcGxhY2UoLyhbYS16QS1aXSkoPz1bYS16QS1aMC05XSkvZywgXCIkMSAqIFwiKTtcbiAgICAgICAgICAgICAgICBhbnMgPSBhbnMucmVwbGFjZSgvKFthLXpBLVowLTldKSg/PVthLXpBLVpdKS9nLCBcIiQxICogXCIpO1xuICAgICAgICAgICAgICAgIGlmIChuLnByZXZpb3VzU2libGluZyAmJiBuLnByZXZpb3VzU2libGluZy5nZXRBdHRyaWJ1dGUoXCJncm91cFwiKSAhPSBcIm9wZXJhdGlvbnNcIilcbiAgICAgICAgICAgICAgICAgICAgYW5zID0gYW5zLnJlcGxhY2UoL14oW2EtekEtWjAtOV0pL2csIFwiICogJDFcIik7XG4gICAgICAgICAgICAgICAgaWYgKG4ubmV4dFNpYmxpbmcgJiYgbi5uZXh0U2libGluZy5nZXRBdHRyaWJ1dGUoXCJncm91cFwiKSAhPSBcIm9wZXJhdGlvbnNcIilcbiAgICAgICAgICAgICAgICAgICAgYW5zID0gYW5zLnJlcGxhY2UoLyhbYS16QS1aMC05XSkkL2csIFwiJDEgKiBcIik7XG4gICAgICAgICAgICAgICAgYW5zID0gXCIgXCIgKyBhbnMgKyBcIiBcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFucyA9IEd1cHB5VXRpbHMuZ2V0X3ZhbHVlKG4pO1xuICAgICAgICB9XG4gICAgfSBlbHNlIGlmKG4ubm9kZU5hbWUgPT0gXCJmXCIpIHtcbiAgICAgICAgdmFyIHJlYWxfdHlwZSA9ICh0ID09IFwibGF0ZXhcIiAmJiB0aGlzLmlzX3NtYWxsKG4pKSA/IFwic21hbGxfbGF0ZXhcIiA6IHQ7XG4gICAgICAgIHZhciBubiA9IHRoaXMueHBhdGhfbm9kZShcIi4vYltAcD0nXCIgKyByZWFsX3R5cGUgKyBcIiddXCIsIG4pIHx8IHRoaXMueHBhdGhfbm9kZShcIi4vYltAcD0nXCIgKyB0ICsgXCInXVwiLCBuKTtcbiAgICAgICAgaWYgKG5uKVxuICAgICAgICAgICAgYW5zID0gdGhpcy5tYW51YWxfcmVuZGVyKHQsIG5uLCByKTtcbiAgICB9IGVsc2UgaWYobi5ub2RlTmFtZSA9PSBcImJcIikge1xuICAgICAgICB2YXIgY3MgPSBbXTtcbiAgICAgICAgdmFyIGkgPSAxO1xuICAgICAgICB2YXIgcGFyID0gbi5wYXJlbnROb2RlO1xuICAgICAgICBmb3IgKHZhciBubiA9IHBhci5maXJzdENoaWxkOyBubiAhPSBudWxsOyBubiA9IG5uLm5leHRTaWJsaW5nKVxuICAgICAgICAgICAgaWYgKG5uLm5vZGVOYW1lID09IFwiY1wiIHx8IG5uLm5vZGVOYW1lID09IFwibFwiKVxuICAgICAgICAgICAgICAgIGNzW2krK10gPSB0aGlzLm1hbnVhbF9yZW5kZXIodCwgbm4sIHIpO1xuICAgICAgICBmb3IgKHZhciBubiA9IG4uZmlyc3RDaGlsZDsgbm4gIT0gbnVsbDsgbm4gPSBubi5uZXh0U2libGluZykge1xuICAgICAgICAgICAgaWYgKG5uLm5vZGVUeXBlID09IDMpXG4gICAgICAgICAgICAgICAgYW5zICs9IG5uLnRleHRDb250ZW50O1xuICAgICAgICAgICAgZWxzZSBpZiAobm4ubm9kZVR5cGUgPT0gMSkge1xuICAgICAgICAgICAgICAgIGlmKG5uLmhhc0F0dHJpYnV0ZShcImRcIikpe1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGltID0gcGFyc2VJbnQobm4uZ2V0QXR0cmlidXRlKFwiZFwiKSk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBqb2luZXIgPSBmdW5jdGlvbihkLCBsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZCA+IDEpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCBsLmxlbmd0aDsgaysrKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsW2tdID0gam9pbmVyKGQtMSwgbFtrXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbC5qb2luKG5uLmdldEF0dHJpYnV0ZSgnc2VwJyArIChkIC0gMSkpKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgYW5zICs9IGpvaW5lcihkaW0sY3NbcGFyc2VJbnQobm4uZ2V0QXR0cmlidXRlKFwicmVmXCIpKV0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZVxuICAgICAgICAgICAgICAgICAgICBhbnMgKz0gY3NbcGFyc2VJbnQobm4uZ2V0QXR0cmlidXRlKFwicmVmXCIpKV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYobi5ub2RlTmFtZSA9PSBcImxcIikge1xuICAgICAgICBhbnMgPSBbXTtcbiAgICAgICAgdmFyIGkgPSAwO1xuICAgICAgICBmb3IgKHZhciBubiA9IG4uZmlyc3RDaGlsZDsgbm4gIT0gbnVsbDsgbm4gPSBubi5uZXh0U2libGluZyl7XG4gICAgICAgICAgICBhbnNbaSsrXSA9IHRoaXMubWFudWFsX3JlbmRlcih0LCBubiwgcik7XG4gICAgICAgIH1cbiAgICB9IGVsc2UgaWYobi5ub2RlTmFtZSA9PSBcImNcIiB8fCBuLm5vZGVOYW1lID09IFwibVwiKSB7XG4gICAgICAgIGZvciAodmFyIG5uID0gbi5maXJzdENoaWxkOyBubiAhPSBudWxsOyBubiA9IG5uLm5leHRTaWJsaW5nKVxuICAgICAgICAgICAgYW5zICs9IHRoaXMubWFudWFsX3JlbmRlcih0LCBubiwgcik7XG4gICAgICAgIGlmICh0ID09IFwibGF0ZXhcIiAmJlxuICAgICAgICAgICAgICAgIG4uZ2V0QXR0cmlidXRlKFwiYnJhY2tldFwiKSA9PSBcInllc1wiICYmXG4gICAgICAgICAgICAgICAgdGhpcy5iYXNlLmV2YWx1YXRlKEd1cHB5RG9jLmJyYWNrZXRfeHBhdGgsIG4sIG51bGwsXG4gICAgICAgICAgICAgICAgWFBhdGhSZXN1bHQuQk9PTEVBTl9UWVBFLCBudWxsKS5ib29sZWFuVmFsdWUpIHsgXG4gICAgICAgICAgICBhbnMgPSBcIlxcXFxsZWZ0KFwiICsgYW5zICsgXCJcXFxccmlnaHQpXCI7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFucztcbn1cblxuR3VwcHlEb2MucHJvdG90eXBlLnBhdGhfdG8gPSBmdW5jdGlvbihuKXtcbiAgICB2YXIgbmFtZSA9IG4ubm9kZU5hbWU7XG4gICAgaWYobmFtZSA9PSBcIm1cIikgcmV0dXJuIFwiZ3VwcHlfbG9jX21cIjtcbiAgICB2YXIgbnMgPSAwO1xuICAgIGZvcih2YXIgbm4gPSBuOyBubiAhPSBudWxsOyBubiA9IG5uLnByZXZpb3VzU2libGluZykgaWYobm4ubm9kZVR5cGUgPT0gMSAmJiBubi5ub2RlTmFtZSA9PSBuYW1lKSBucysrO1xuICAgIHJldHVybiB0aGlzLnBhdGhfdG8obi5wYXJlbnROb2RlKStcIl9cIituYW1lK1wiXCIrbnM7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gR3VwcHlEb2M7XG4iXX0=
